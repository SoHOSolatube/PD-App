rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ──────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      let userDoc = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userDoc) ? get(userDoc).data.role : 'none';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isManager() {
      return isAuthenticated() && getUserRole() == 'manager';
    }

    function isAdminOrManager() {
      return isAuthenticated()
        && (getUserRole() == 'admin' || getUserRole() == 'manager');
    }

    // ── Contacts ──────────────────────────────────────
    match /contacts/{contactId} {
      allow read, write: if isAdminOrManager();
    }

    // ── Events ────────────────────────────────────────
    match /events/{eventId} {
      allow read: if true; // Public can view published events
      allow write: if isAdminOrManager();

      match /registrations/{registrationId} {
        allow read: if isAdminOrManager();
        allow create: if true; // Public can register
      }

      match /surveys/{surveyId} {
        allow read: if true;
        allow write: if isAdminOrManager();
      }

      match /surveyResponses/{responseId} {
        allow read: if isAdminOrManager();
        allow create: if true; // Public can submit responses
      }
    }

    // ── Messages ──────────────────────────────────────
    match /messages/{messageId} {
      allow read, write: if isAdminOrManager();
    }

    // ── Templates ─────────────────────────────────────
    match /templates/{templateId} {
      allow read, write: if isAdminOrManager();
    }

    // ── Surveys ───────────────────────────────────────
    match /surveys/{surveyId} {
      allow read: if true;
      allow write: if isAdminOrManager();
    }

    // ── Suppression ───────────────────────────────────
    match /suppression/{recordId} {
      allow read, write: if isAdminOrManager();
    }

    // ── Prospects ─────────────────────────────────────
    match /prospects/{prospectId} {
      allow read, write: if isAdminOrManager();

      match /conversations/{messageId} {
        allow read, write: if isAdminOrManager();
      }
    }

    // ── Playbooks ─────────────────────────────────────
    match /playbooks/{playbookId} {
      allow read: if isAdminOrManager();
      allow write: if isAdmin();
    }

    // ── Skills ────────────────────────────────────────
    match /skills/{skillId} {
      allow read: if isAdminOrManager();
      allow write: if isAdmin();
    }

    // ── Users ─────────────────────────────────────────
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Allow authenticated users to create their own doc (needed for initial setup)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isAdmin();
    }

    // ── Settings ──────────────────────────────────────
    match /settings/{settingId} {
      allow read, write: if isAdminOrManager();
    }
    // ── Logs ──────────────────────────────────────────
    match /logs/{logId} {
      allow read: if isAdminOrManager();
      allow create: if isAdminOrManager();
    }

    // ── Pending Requests ──────────────────────────────
    match /pendingRequests/{requestId} {
      allow read, write: if isAdminOrManager();
      allow create: if true; // Public can submit signup requests
    }
  }
}
